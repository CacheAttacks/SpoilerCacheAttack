setwd("~/MA_2/master-moritz_krebbel-drive_by_cache_attacks/code/r/prime_probe")
source("find_es.R")
source("smoothed_z-score_algo.R")

data <- "1010 \n182 \n65 \n78 \n66 \n62 \n62 \n66 \n66 \n64 \n75 \n62 \n65 \n63 \n63 \n65 \n64 \n63 \n332 \n335 \n409 \n239 \n148 \n69 \n65 \n70 \n66 \n66 \n68 \n65 \n65 \n64 \n63 \n71 \n65 \n64 \n65 \n64 \n64 \n64 \n65 \n63 \n64 \n62 \n63 \n64 \n63 \n63 \n64 \n65 \n64 \n72 \n69 \n72 \n76 \n69 \n74 \n71 \n69 \n67 \n72 \n194 \n245 \n309 \n364 \n185 \n62 \n63 \n68 \n63 \n66 \n65 \n278 \n351 \n354 \n249 \n93 \n63 \n64 \n68 \n65 \n61 \n61 \n212 \n270 \n331 \n296 \n316 \n224 \n88 \n67 \n67 \n67 \n62 \n66 \n61 \n62 \n77 \n60 \n64 \n63 \n63 \n63 \n65 \n64 \n65 \n63 \n64 \n65 \n240 \n323 \n369 \n419 \n280 \n328 \n326 \n348 \n389 \n342 \n406 \n404 \n491 \n399 \n326 \n228 \n118 \n72 \n67 \n70 \n69 \n69 \n69 \n68 \n65 \n65 \n66 \n70 \n71 \n66 \n67 \n82 \n73 \n71 \n73 \n73 \n63 \n69 \n69 \n71 \n73 \n69 \n175 \n264 \n343 \n374 \n198 \n69 \n69 \n66 \n65 \n72 \n64 \n73 \n67 \n69 \n67 \n69 \n67 \n73 \n68 \n68 \n65 \n66 \n70 \n67 \n72 \n70 \n72 \n68 \n66 \n67 \n67 \n66 \n76 \n75 \n65 \n67 \n68 \n65 \n68 \n68 \n73 \n72 \n69 \n256 \n386 \n374 \n262 \n146 \n73 \n65 \n65 \n69 \n66 \n238 \n322 \n354 \n306 \n239 \n72 \n68 \n65 \n67 \n189 \n299 \n314 \n404 \n278 \n89 \n90 \n65 \n64 \n72 \n66 \n65 \n66 \n65 \n65 \n66 \n64 \n65 \n64 \n64 \n65 \n66 \n65 \n253 \n316 \n384 \n374 \n365 \n343 \n343 \n371 \n342 \n371 \n343 \n373 \n303 \n331 \n331 \n335 \n189 \n61 \n64 \n65 \n65 \n65 \n65 \n65 \n65 \n65 \n65 \n60 \n58 \n64 \n64 \n65 \n66 \n65 \n57 \n59 \n64 \n64 \n66 \n65 \n65 \n63 \n64 \n64 \n64 \n65 \n63 \n66 \n69 \n254 \n338 \n328 \n344 \n179 \n64 \n65 \n65 \n63 \n64 \n65 \n66 \n65 \n65 \n63 \n64 \n63 \n65 \n65 \n65 \n64 \n63 \n64 \n67 \n67 \n65 \n65 \n64 \n63 \n66 \n63 \n64 \n65 \n66 \n65 \n64 \n64 \n65 \n63 \n65 \n63 \n65 \n65 \n65 \n64 \n64 \n65 \n65 \n65 \n65 \n206 \n372 \n327 \n391 \n228 \n213 \n65 \n64 \n65 \n65 \n254 \n267 \n413 \n302 \n266 \n64 \n63 \n65 \n64 \n64 \n93 \n276 \n298 \n277 \n367 \n180 \n66 \n65 \n65 \n63 \n64 \n64 \n65 \n65 \n64 \n64 \n233 \n217 \n184 \n276 \n312 \n316 \n415 \n386 \n332 \n365 \n473 \n405 \n355 \n361 \n387 \n311 \n316 \n356 \n338 \n246 \n110 \n60 \n63 \n63 \n65 \n64 \n64 \n64 \n65 \n64 \n63 \n66 \n64 \n65 \n64 \n64 \n65 \n64 \n66 \n64 \n58 \n66 \n61 \n65 \n65 \n65 \n64"
data2 <- "\n65 \n63 \n65 \n65 \n65 \n278 \n351 \n356 \n334 \n215 \n65 \n64 \n65 \n65 \n65 \n64 \n64 \n61 \n64 \n64 \n64 \n65 \n64 \n62 \n66 \n65 \n65 \n63 \n64 \n64 \n71 \n65 \n65 \n65 \n64 \n65 \n63 \n66 \n66 \n66 \n67 \n66 \n64 \n65 \n65 \n63 \n64 \n66 \n65 \n64 \n65 \n62 \n65 \n66 \n255 \n330 \n353 \n290 \n232 \n64 \n63 \n65 \n68 \n66 \n64 \n235 \n351 \n287 \n267 \n233 \n134 \n63 \n63 \n60 \n64 \n60 \n65 \n247 \n282 \n323 \n303 \n185 \n65 \n68 \n64 \n64 \n65 \n65 \n67 \n65 \n64 \n64 \n67 \n66 \n62 \n65 \n63 \n62 \n59 \n65 \n63 \n63 \n251 \n364 \n348 \n345 \n381 \n422 \n393 \n533 \n383 \n399 \n318 \n364 \n303 \n290 \n262 \n140 \n62 \n59 \n64 \n61 \n64 \n63 \n65 \n68 \n62 \n61 \n62 \n61 \n62 \n62 \n63 \n64 \n62 \n62 \n64 \n64 \n65 \n62 \n61 \n63 \n65 \n63 \n62 \n64 \n61 \n113 \n238 \n289 \n385 \n280 \n183 \n60 \n62 \n60 \n63 \n60 \n62 \n65 \n65 \n64 \n63 \n62 \n62 \n65 \n65 \n66 \n69 \n64 \n62 \n61 \n64 \n63 \n64 \n62 \n64 \n65 \n64 \n65 \n65 \n69 \n69 \n63 \n63 \n63 \n64 \n63 \n64 \n63 \n64 \n64 \n63 \n64 \n64 \n61 \n63 \n263 \n337 \n321 \n297 \n189 \n64 \n64 \n63 \n65 \n64 \n63 \n121 \n234 \n356 \n337 \n375 \n210 \n63 \n64 \n64 \n60 \n64 \n273 \n298 \n268 \n387 \n180 \n214 \n109 \n61 \n64 \n63 \n64 \n63 \n63 \n64 \n63 \n65 \n63 \n63 \n66 \n64 \n61 \n61 \n63 \n95 \n261 \n357 \n355 \n353 \n364 \n360 \n287 \n302 \n333 \n330 \n418 \n406 \n363 \n324 \n327 \n274 \n240 \n220 \n63 \n67 \n67 \n67 \n67 \n63 \n64 \n64 \n65 \n67 \n70 \n64 \n69 \n66 \n66 \n67 \n61 \n65 \n53 \n65 \n60 \n69 \n68 \n64 \n63 \n63 \n65 \n64 \n60 \n117 \n210 \n351 \n351 \n318 \n113 \n60 \n64 \n62 \n67 \n65 \n37 \n66 \n60 \n68 \n61 \n58 \n59 \n62 \n68 \n62 \n61 \n64 \n26 \n67 \n60 \n62 \n63 \n59 \n64 \n65 \n61 \n61 \n64 \n61 \n58 \n56 \n70 \n64 \n65 \n64 \n62 \n63 \n63 \n63 \n61 \n62 \n64 \n62 \n64 \n295 \n291 \n384 \n272 \n211 \n58 \n63 \n64 \n65 \n65 \n65 \n244 \n308 \n317 \n299 \n241 \n82 \n60 \n64 \n63 \n61 \n60 \n148 \n230 \n317 \n293 \n267 \n200 \n62 \n64 \n63 \n62 \n65 \n59 \n65 \n60 \n64 \n64 \n63 \n60 \n64 \n61 \n64 \n65 \n64 \n61 \n67 \n170 \n226 \n419 \n324 \n368 \n338 \n339 \n340 \n373 \n381 \n275 \n323 \n290 \n342 \n435 \n365 \n357 \n219 \n62 \n63 \n63 \n63 \n65 \n65 \n62 \n62 \n63 \n65 \n63 \n62"
data3 <- "\n64 \n62 \n67 \n66 \n67 \n63 \n64 \n63 \n61 \n59 \n65 \n63 \n64 \n63 \n62 \n63 \n64 \n63 \n61 \n125 \n351 \n301 \n363 \n218 \n181 \n60 \n63 \n61 \n62 \n65 \n64 \n66 \n69 \n66 \n69 \n68 \n67 \n65 \n59 \n61 \n63 \n63 \n65 \n64 \n61 \n63 \n62 \n62 \n64 \n63 \n66 \n64 \n60 \n62 \n62 \n63 \n64 \n72 \n67 \n64 \n62 \n64 \n62 \n63 \n64 \n64 \n62 \n65 \n68 \n67 \n288 \n356 \n425 \n320 \n184 \n65 \n67 \n65 \n60 \n64 \n63 \n222 \n271 \n299 \n294 \n261 \n60 \n60 \n62 \n61 \n65 \n59 \n72 \n71 \n258 \n350 \n288 \n294 \n245 \n61 \n62 \n69 \n61 \n64 \n58 \n61 \n63 \n62 \n65 \n64 \n63 \n62 \n61 \n65 \n62 \n65 \n62 \n62 \n271 \n321 \n326 \n403 \n349 \n320 \n380 \n321 \n333 \n357 \n321 \n310 \n319 \n418 \n366 \n377 \n211 \n65 \n61 \n60 \n61 \n64 \n62 \n65 \n63 \n62 \n59 \n62 \n62 \n63 \n58 \n65 \n66 \n56 \n68 \n68 \n67 \n67 \n62 \n70 \n72 \n70 \n73 \n66 \n74 \n71 \n70 \n72 \n66 \n159 \n254 \n373 \n355 \n291 \n210 \n178 \n65 \n66 \n66 \n64 \n62 \n63 \n62 \n62 \n62 \n62 \n61 \n64 \n61 \n63 \n64 \n64 \n61 \n62 \n63 \n60 \n62 \n62 \n63 \n61 \n61 \n63 \n63 \n60 \n63 \n62 \n63 \n60 \n61 \n65 \n63 \n61 \n70 \n69 \n67 \n59 \n63 \n62 \n164 \n242 \n338 \n339 \n247 \n170 \n66 \n71 \n68 \n68 \n68 \n68 \n282 \n305 \n270 \n365 \n213 \n129 \n63 \n71 \n62 \n58 \n61 \n231 \n327 \n374 \n283 \n196 \n61 \n62 \n63 \n61 \n64 \n60 \n63 \n60 \n63 \n62 \n62 \n63 \n63 \n63 \n65 \n59 \n63 \n61 \n57 \n60 \n259 \n277 \n301 \n315 \n327 \n300 \n326 \n397 \n324 \n356 \n328 \n364 \n306 \n387 \n430 \n398 \n176 \n67 \n64 \n66 \n63 \n65 \n62 \n67 \n63 \n64 \n63 \n69 \n66 \n65 \n72 \n64 \n63 \n61 \n62 \n63 \n63 \n65 \n71 \n70 \n70 \n72 \n69 \n71 \n67 \n315 \n318 \n379 \n353 \n200 \n64 \n65 \n78 \n69 \n66 \n71 \n68 \n71 \n67 \n69 \n67 \n65 \n62 \n62 \n62 \n62 \n61 \n62 \n66 \n61 \n62 \n64 \n63 \n62 \n63 \n55 \n72 \n62 \n60 \n64 \n60 \n60 \n62 \n68 \n69 \n68 \n60 \n70 \n71 \n66 \n293 \n450 \n330 \n325 \n249 \n242 \n65 \n244 \n384 \n345 \n349 \n213 \n67 \n67 \n69 \n66 \n68 \n208 \n301 \n395 \n417 \n207 \n63 \n68 \n65 \n65 \n66 \n65 \n68 \n70 \n65 \n66 \n66 \n67 \n68 \n67 \n61 \n62 \n58 \n230 \n311 \n464 \n442 \n437 \n448 \n347 \n444 \n333 \n372 \n359 \n362 \n333 \n317 \n333 \n189 \n63 \n60 \n59 \n60 \n58 \n57 \n58 \n58 \n58 \n58 \n57 \n58 \n59 \n59 \n57 \n59 \n58 \n59 \n63 \n62 \n61 \n62 \n60 \n63 \n60 \n59 \n61 \n59 \n59 \n64 \n61 \n64 \n243 \n335 \n321 \n290 \n323 \n139 \n61 \n57 \n64 \n62 \n66 \n68 \n68 \n71 \n72 \n69 \n67 \n64 \n64 \n66 \n65 \n67 \n68 \n68 \n65 \n61 \n63 \n60 \n62 \n64 \n61 \n62 \n64 \n61 \n62 \n63 \n64 \n63 \n65 \n61 \n63 \n65 \n64 \n60 \n67 \n68 \n69 \n70 \n73 \n284 \n333 \n358 \n305 \n186 \n60 \n62 \n64 \n59 \n62 \n60 \n224 \n273 \n325 \n369 \n238 \n84 \n64 \n63 \n62 \n61 \n64 \n64 \n218 \n342 \n266 \n308 \n157 \n63 \n62 \n62 \n62 \n62 \n59 \n63 \n67 \n61 \n60 \n63 \n64 \n62 \n58 \n64 \n62 \n62 \n61 \n61 \n68 \n296 \n341 \n316 \n379 \n301 \n332 \n340 \n370 \n342 \n424 \n326 \n367 \n302 \n330 \n333 \n327 \n269 \n239 \n68 \n65 \n66 \n68 \n64 \n64 \n58 \n63 \n59 \n61 \n57 \n64 \n62 \n62 \n63 \n63 \n63 \n63 \n70 \n73 \n71 \n72 \n63 \n59 \n59 \n65 \n62 \n63 \n61 \n66 \n64 \n140 \n236 \n349 \n330 \n361 \n108 \n63 \n62 \n61 \n61 \n61 \n63 \n65 \n65 \n61 \n58 \n62 \n62 \n63 \n60 \n63 \n62 \n60 \n63 \n63 \n66 \n65 \n65 \n64 \n64 \n61 \n64 \n62 \n61 \n63 \n62 \n63 \n63 \n65 \n65 \n62 \n63 \n63 \n64 \n61 \n62 \n62 \n62 \n60 \n59 \n240 \n280 \n298 \n270 \n242 \n63 \n61 \n64 \n61 \n62 \n63 \n64 \n242 \n264 \n305 \n355 \n187 \n218 \n82 \n65 \n66 \n68 \n152 \n267 \n273 \n314 \n264 \n195 \n"
data <- paste0(data,data2,data3)

tbl <- data.table::fread(data)
tbl <- tbl[0:450,]

#tbl[,"sample"] <- 1:nrow(tbl)
max_value <- 400
tbl[tbl$V1>max_value, "V1"] <- max_value
#plot <- ggplot2::ggplot(tbl, ggplot2::aes(x = sample, y = V1)) + ggplot2::geom_histogram(stat = "identity")
#print(plot)

y <- tbl[[1]][(length(tbl[[1]])*0.2):(length(tbl[[1]])-10)]
y <- mean_smooth(y)

result <- calc_smoothed_z_score(y)

#"bitstr = 0010001110, pause cycles = 1500, repeat prime bit is 1 = 1, 
#repeat prime sync = 10, sender prime 1 add, rec prime/probe 16 add single loop, 
#bit detection simple threshold, threshold = median * 2, bits between sync = 10"

#w 10 , s 12:213 , c 1500 , r 1 , n 10 , y 10, p 0 10

require( tikzDevice )
tikz( "covert_channel_example.tex" )

#unten,links,oben,rechts
par(mfrow = c(2,1),oma = c(2,2,0,0) + 0.1,mar = c(4,4,2,1) + 0.2)
plot(1:length(y),y,type="l",xlab="Samples", ylab="Zugrifsfzeit", yaxt="n") 
x<-c(0,100,200,300,400)
axis(2, at=x,labels=x, las=0)
lines(1:length(y),rep(threshold_factor*median(y),length(y)),type="l",col="grey",lwd=2)

plot(result$signals,type="S",ylab="Bitwert",xlab="",ylim=c(0,1),lwd=2, yaxt="n")
x<-c(0,1)
axis(2, at=x,labels=x, las=0)

dev.off()
